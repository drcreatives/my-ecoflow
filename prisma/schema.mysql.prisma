// EcoFlow Delta 2 Dashboard Database Schema - MySQL Version
// Optimized schema for MySQL/MariaDB on cPanel

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  relationMode = "prisma" // Use Prisma relation mode for better compatibility
}

// Users table (for authentication and user management)
model User {
  id           String   @id @default(cuid()) // Using cuid() instead of uuid() for MySQL
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  firstName    String?  @map("first_name") @db.VarChar(100)
  lastName     String?  @map("last_name") @db.VarChar(100)
  timezone     String?  @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.DateTime(0)
  
  // Relations
  devices Device[]
  
  @@map("users")
  @@index([email])
}

// Device registrations
model Device {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  deviceSn   String   @unique @map("device_sn") @db.VarChar(100)
  deviceName String?  @map("device_name") @db.VarChar(255)
  deviceType String   @default("DELTA_2") @map("device_type") @db.VarChar(50)
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.DateTime(0)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.DateTime(0)
  
  // Relations
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  readings       DeviceReading[]
  settings       DeviceSetting[]
  dailySummaries DailySummary[]
  alerts         DeviceAlert[]
  
  @@map("devices")
  @@index([userId])
  @@index([deviceSn])
  @@index([isActive])
}

// Device data readings (real-time and historical data)
model DeviceReading {
  id               String   @id @default(cuid())
  deviceId         String   @map("device_id")
  batteryLevel     Float?   @map("battery_level") @db.Float
  inputWatts       Float?   @map("input_watts") @db.Float
  outputWatts      Float?   @map("output_watts") @db.Float
  acOutputWatts    Float?   @map("ac_output_watts") @db.Float
  dcOutputWatts    Float?   @map("dc_output_watts") @db.Float
  usbOutputWatts   Float?   @map("usb_output_watts") @db.Float
  temperature      Float?   @db.Float
  remainingTime    Int?     @map("remaining_time") // in minutes
  status           String   @default("normal") @db.VarChar(50)
  rawData          String?  @map("raw_data") @db.Text // JSON stored as text in MySQL
  recordedAt       DateTime @default(now()) @map("recorded_at") @db.DateTime(0)
  
  // Relations
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  @@map("device_readings")
  @@index([deviceId])
  @@index([recordedAt])
  @@index([deviceId, recordedAt])
}

// Device settings/configuration
model DeviceSetting {
  id               String   @id @default(cuid())
  deviceId         String   @map("device_id")
  settingKey       String   @map("setting_key") @db.VarChar(100)
  settingValue     String   @map("setting_value") @db.Text
  category         String?  @db.VarChar(50)
  description      String?  @db.Text
  lastModified     DateTime @default(now()) @map("last_modified") @db.DateTime(0)
  lastModifiedBy   String?  @map("last_modified_by")
  
  // Relations
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  @@unique([deviceId, settingKey])
  @@map("device_settings")
  @@index([deviceId])
  @@index([settingKey])
}

// Daily usage summaries (for analytics and reporting)
model DailySummary {
  id                 String   @id @default(cuid())
  deviceId           String   @map("device_id")
  summaryDate        DateTime @map("summary_date") @db.Date
  totalInputKwh      Float    @default(0) @map("total_input_kwh") @db.Float
  totalOutputKwh     Float    @default(0) @map("total_output_kwh") @db.Float
  avgBatteryLevel    Float?   @map("avg_battery_level") @db.Float
  minBatteryLevel    Float?   @map("min_battery_level") @db.Float
  maxBatteryLevel    Float?   @map("max_battery_level") @db.Float
  avgTemperature     Float?   @map("avg_temperature") @db.Float
  maxTemperature     Float?   @map("max_temperature") @db.Float
  totalOnlineMinutes Int      @default(0) @map("total_online_minutes")
  cycleCount         Int      @default(0) @map("cycle_count")
  createdAt          DateTime @default(now()) @map("created_at") @db.DateTime(0)
  
  // Relations
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  @@unique([deviceId, summaryDate])
  @@map("daily_summaries")
  @@index([deviceId])
  @@index([summaryDate])
}

// Device alerts and notifications
model DeviceAlert {
  id          String   @id @default(cuid())
  deviceId    String   @map("device_id")
  alertType   String   @map("alert_type") @db.VarChar(50)
  severity    String   @db.VarChar(20) // 'info', 'warning', 'critical'
  message     String   @db.Text
  isRead      Boolean  @default(false) @map("is_read")
  isResolved  Boolean  @default(false) @map("is_resolved")
  triggeredAt DateTime @default(now()) @map("triggered_at") @db.DateTime(0)
  resolvedAt  DateTime? @map("resolved_at") @db.DateTime(0)
  
  // Relations
  device Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  
  @@map("device_alerts")
  @@index([deviceId])
  @@index([isRead])
  @@index([isResolved])
  @@index([triggeredAt])
}
